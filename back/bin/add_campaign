#!/usr/bin/env ruby

# Requirements:
# Ruby with installed activesupport gem
#
# Usage:
# cd citizenlab
# back/bin/add_campaign initiative_resubmitted_for_review new_cosponsor_added

require 'fileutils'
require 'active_support/all'

# path to your application root.
APP_ROOT = File.expand_path('../..', __dir__)

def system!(*args)
  system(*args) || abort("\n== Command #{args} failed ==")
end

example_campaign = ARGV[0] # underscored
result_campaign = ARGV[1] # underscored

def replace_campaign(content, example_campaign, result_campaign)
  content.gsub(example_campaign, result_campaign)
    .gsub(example_campaign.camelize, result_campaign.camelize)
    .gsub(example_campaign.camelize(:lower), result_campaign.camelize(:lower))
end

def includes_campaign?(content, example_campaign)
  content.match?(/#{example_campaign}|#{example_campaign.camelize}|#{example_campaign.camelize(:lower)}/)
end

FileUtils.chdir APP_ROOT do
  new_files = `git ls-files`.split("\n").select { |file| includes_campaign?(file, example_campaign) }

  new_files.each do |example_file|
    result_file = replace_campaign(example_file, example_campaign, result_campaign)
    FileUtils.mkdir_p File.dirname(result_file)

    result_content = replace_campaign(File.read(example_file), example_campaign, result_campaign)

    File.write(result_file, result_content)
  end

  edited_files = %w[
    back/app/services/notification_service.rb
    back/engines/free/email_campaigns/app/services/email_campaigns/delivery_service.rb
    back/engines/free/email_campaigns/config/locales/en.yml
    back/engines/free/email_campaigns/spec/factories/campaigns.rb
    back/spec/factories/notifications.rb

    front/app/api/notifications/types.ts
    front/app/containers/MainHeader/NotificationMenu/components/Notification/index.tsx
    front/app/containers/MainHeader/NotificationMenu/messages.ts
  ]

  edited_files.each do |file|
    lines = File.read(file).split("\n")
    content = lines.each_with_index do |line, i|
      if includes_campaign?(line, example_campaign)
        lines[i] = [replace_campaign(line, example_campaign, result_campaign), line].join("\n")
      end
    end.join("\n") + "\n"
    File.write(file, content)
  end
end
