version: 2.1

parameters:

  citizenlab_branch:
    type: string
    default: master

jobs:
  # *************** back ***************
  
  back-build-ee-docker-image:
    working_directory: /citizenlab/back
    docker:
      - image: docker:stable-git
    steps:
      - checkout:
          path: /citizenlab-private

      - add_ssh_keys:
          fingerprints:
            - "94:9a:7c:8d:50:73:cc:28:06:47:d7:98:91:0b:00:ff"
      - run: |
          git clone git@github.com:CitizenLabDotCo/citizenlab --depth 5 --branch << pipeline.parameters.citizenlab_branch >> /citizenlab

      - setup_remote_docker:
          docker_layer_caching: true

      - run: |
          docker build -t citizenlabdotco/back-ee:$CIRCLE_SHA1 .
      - run: |
          docker login -u $DOCKER_USER -p $DOCKER_PASS
          docker push citizenlabdotco/back-ee:$CIRCLE_SHA1

workflows:
  version: 2

  back:
    jobs:
      - back-build-ee-docker-image:
          context: docker-hub-access
