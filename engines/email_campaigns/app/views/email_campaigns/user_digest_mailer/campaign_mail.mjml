<mjml>
  <%= render partial: "application/header" %>
  <mj-body background-color="#FFFFFF">

    <!-- Preheader -->
    <mj-section>
      <mj-column>
        <mj-text>
          <span style="color: transparent; display: none; height: 0; max-height: 0; max-width: 0; opacity: 0; overflow: hidden; mso-hide: all; visibility: hidden; width: 0;">
            <%= formatMessage('preheader', values: {organizationName: localize(@tenant.settings.dig('core','organization_name'))}) %>
          </span>
        </mj-text>
      </mj-column>
    </mj-section>

    <%= render partial: "application/logo_medium_top" %>

    <!-- Main header -->
    <mj-section padding="25px 25px 20px">
      <mj-column>
        <mj-text>
          <h1 style="margin-bottom: 20px">
            <%= formatMessage('title_your_weekly_report') %>
          </h1>
          <p>
            <%= formatMessage('intro_text', 
            values: {organizationName: localize(@tenant.settings.dig('core','organization_name'))}) %>
          </p>
        </mj-text>
      </mj-column>
    </mj-section>

    <!-- Notifications -->
    <mj-section 
      padding="0 25px 40px"
      background-color="#fff"
      border-radius="5px"
      text-align="left"
    >
      <mj-column border="1px solid #eaeaea" padding="30px 25px" background-color="#fff" border-radius="5px">
        <mj-text padding-bottom="20px">
          <h2>
            <% if @command[:event_payload][:notifications_count] == 0 %>
              <%= formatMessage('no_notifications') %>
            <% elsif @command[:event_payload][:notifications_count] == 1 %>
              <%= formatMessage('one_notification') %>
            <% elsif @command[:event_payload][:notifications_count] > 1 %>
              <%= formatMessage('multiple_notifications', values: {notifCount: @command[:event_payload][:notifications_count]}) %>
            <% end %>
          </h2>
          <p style="margin-top: 10px;">
            <% if @command[:event_payload][:notifications_count] == 0 %>
              <%= formatMessage('no_unread_notifications') %>
            <% elsif @command[:event_payload][:notifications_count] > 0 %>
              <%= formatMessage('unread_notifications') %>
            <% end %>
          </p>
        </mj-text>
        <mj-button 
          color="#fff"
          background-color="#044D6C" 
          border-radius="5px"
          href="<%= @url_service.home_url(tenant: @tenant, locale: @locale) %>"
          align="left"
        >
          <%= formatMessage('cta_go_to_the_platform') %>
        </mj-button>
      </mj-column>
    </mj-section>

    <!-- Trending ideas -->
    <mj-section padding-bottom="20px">
      <mj-column>
        <mj-text padding="0 25px">
          <h2>
            <% if @command[:event_payload][:top_ideas].present? %>
              <%= formatMessage('trending_ideas') %>
            <% end %>
          </h2>
          <p>
            <% if @command[:event_payload][:top_ideas].present? %>
              <%= formatMessage("trending_ideas_text") %>
            <% end %>
          </p>
        </mj-text>
      </mj-column>
    </mj-section>
      
    
    <mj-raw><% @command[:event_payload][:top_ideas].each do |top_idea| %></mj-raw>
      <mj-wrapper padding="0px 25px 20px">   
        <mj-section border="1px solid #eaeaea" padding="0px 25px 0px">
          <mj-column>
            <mj-text>
              <a style="font-size: 14px; font-weight: 500; color: #000; text-decoration: none;" href="<%= top_idea[:url] %>">
                <h3 style="margin-bottom: 10px">
                  <%= localize(top_idea[:title_multiloc])[0...80] %>
                </h3>
              </a>                   
            </mj-text>
            <mj-table width="200px">
              <tr>
                <td>
                  <span style="font-size: 24px; font-weight: 700; color: rgb(111, 119, 125);">
                    <img width="18px" src="http://res.cloudinary.com/citizenlabco/image/upload/v1530712393/thumb_up_tmxhbw.png" alt="Thumbs up">
                  </span>
                  <span style="font-size: 14px; font-weight: 700;"><%= top_idea[:upvotes_count] %></span>
                </td>
                <td>
                  <span style="font-size: 24px; font-weight: 700; color: rgb(111, 119, 125);">
                    <img width="18px" src="http://res.cloudinary.com/citizenlabco/image/upload/v1530712393/thumb_down_dydzme.png" alt="Thumbs down">
                  </span>
                  <span style="font-size: 14px; font-weight: 700;"><%= top_idea[:downvotes_count] %></span>
                </td>
                <td>
                  <span style="font-size: 16px; font-weight: 700; color: rgb(111, 119, 125);">
                    <img width="18px" src="http://res.cloudinary.com/citizenlabco/image/upload/v1530712393/comment_srfoec.png" alt="Comment">
                  </span>
                  <span style="font-size: 14px; font-weight: 700;"><%= top_idea[:comments_count] %></span>
                </td>
              </tr>
            </mj-table>
            <mj-raw><% top_idea[:top_comments].each do |top_comment| %></mj-raw>
                <mj-table cellpadding="15" padding-top="20px">
                  <tr style="background-color:#F3F7FB; text-align: left;">
                    <td style="text-align: left; width: 100%" colspan="4">
                      <mj-text style="font-size: 12px;">
                        <%= formatMessage('commented', values: {
                          authorFirstName: "<span style=\"font-weight:bold; color: #000;\">#{top_comment[:author_first_name]}</span>"
                        },
                        escape_html: false
                        ) %>
                        <p style="margin: 15px 0 0;">
                          <%= localize(top_comment[:body_multiloc])[0...140] %>
                        </p>
                      </mj-text>
                    </td>
                  </tr>
                </mj-table>
            <mj-raw><% end %></mj-raw>
            <mj-text>&nbsp;</mj-text>
          </mj-column>
        </mj-section>
      </mj-wrapper> 
    <mj-raw><% end %></mj-raw>

    <!-- New initiatives -->
    <mj-section padding="0 25px 30px">
      <mj-column>
        <mj-text>
          <h2>
            <% if @command[:event_payload][:new_initiatives].present? %>
              <%= formatMessage('title_proposals') %>
            <% end %>
          </h2>
          <p>
            <%  if @command[:event_payload][:new_initiatives].present? %>
              <%= formatMessage('proposals_started_text') %>
            <% end %>
          </p>
        </mj-text>

        <mj-raw><% @command[:event_payload][:new_initiatives].each do |new_initiative| %></mj-raw>
          <mj-table cellpadding="15" padding-top="20px">
              <% @diff_days = ((Time.now - Time.parse(new_initiative[:published_at])) / 1.day) %>

              <tr style="border:1px solid #ecedee; background-color: #FFFFFF">
                <td style="width: 80px;">
                  <span style="font-size: 24px; font-weight: 700; color: rgb(111, 119, 125);">
                    <img width="96px" src="<%= new_initiative[:images].first[:versions][:small] %>">
                  </span>
                </td>
                <td width="200" style="text-align: left;">
                  <a style="font-size: 14px; font-weight: 300; color: #000; text-decoration: none;" href="<%= new_initiative[:url] %>">
                    <%= localize(new_initiative[:title_multiloc])[0...80] %>
                  </a>
                  <span style="font-size: 12px; font-weight: 300; color: rgb(111, 119, 125)">
                    <% if @diff_days < 1 %>
                      <%= formatMessage('today_by_author', values: {author: new_initiative[:author_name]}) %>
                    <% elsif @diff_days < 2 %>
                      <%= formatMessage('yesterday_by_author', values: {author: new_initiative[:author_name]}) %>
                    <% else %>
                      <%= formatMessage('x_days_ago_by_author', values: {x: @diff_days.round, author: new_initiative[:author_name]}) %>
                    <% end %>
                  </span>
                </td>
                <td style="width: 40px;">
                  <span style="font-size: 24px; font-weight: 700; color: rgb(111, 119, 125);">
                    <img width="18px" src="http://res.cloudinary.com/citizenlabco/image/upload/v1530712393/thumb_up_tmxhbw.png" alt="Thumbs up">
                  </span>
                  <span style="font-size: 14px; font-weight: 700;"><%= new_initiative[:upvotes_count] %></span>
                </td>
                <td style="width: 40px">
                  <span style="font-size: 16px; font-weight: 700; color: rgb(111, 119, 125);">
                    <img width="18px" src="http://res.cloudinary.com/citizenlabco/image/upload/v1530712393/comment_srfoec.png" alt="Comment">
                  </span>
                  <span style="font-size: 14px; font-weight: 700;"><%= new_initiative[:comments_count] %></span>
                </td>
              </tr>
            <mj-text>&nbsp;</mj-text>
          </mj-table>
        <mj-raw><% end %></mj-raw>
      </mj-column>
    </mj-section>

    <!-- Proposals that reached threshold -->
    <mj-section padding="0 25px 30px">
      <mj-column>
        <mj-text>
          <h2>
            <% if @command[:event_payload][:succesful_initiatives].present? %>
              <%= formatMessage('title_successful_proposals') %>
            <% end %>
          </h2>
          <p>
            <% if @command[:event_payload][:succesful_initiatives].present? %>
              <%= formatMessage('successful_proposals_text') %>
            <% end %>
          </p>
        </mj-text>

        <mj-raw><% @command[:event_payload][:succesful_initiatives].each do |succesful_initiative| %></mj-raw>
          <mj-table cellpadding="15" padding-top="20px">
              <% @diff_days = ((Time.now - Time.parse(succesful_initiative[:published_at])) / 1.day) %>

              <tr style="border:1px solid #ecedee; background-color: #FFFFFF">
                <td style="width: 80px;">
                  <span style="font-size: 24px; font-weight: 700; color: rgb(111, 119, 125);">
                    <img width="96px" src="<%= succesful_initiative[:images].first[:versions][:small] %>">
                  </span>
                </td>
                <td width="200" style="text-align: left;">
                  <a style="font-size: 14px; font-weight: 300; color: #000; text-decoration: none;" href="<%= succesful_initiative[:url] %>">
                    <%= localize(succesful_initiative[:title_multiloc])[0...80] %>
                  </a>
                  <span style="font-size: 12px; font-weight: 300; color: rgb(111, 119, 125)">
                    <% if @diff_days < 1 %>
                      <%= formatMessage('today_by_author', values: {author: succesful_initiative[:author_name]}) %>
                    <%  elsif @diff_days < 2 %>
                      <%= formatMessage('yesterday_by_author', values: {author: succesful_initiative[:author_name]}) %>
                    <%  else %>
                      <%= formatMessage('x_days_ago_by_author',  values: {x: @diff_days.round, author: succesful_initiative[:author_name]}) %>
                    <% end %>
                  </span>
                </td>
                <td style="width: 40px;">
                  <span style="font-size: 24px; font-weight: 700; color: rgb(111, 119, 125);">
                    <img width="18px" src="http://res.cloudinary.com/citizenlabco/image/upload/v1530712393/thumb_up_tmxhbw.png" alt="Thumbs up">
                  </span>
                  <span style="font-size: 14px; font-weight: 700;"><%= succesful_initiative[:upvotes_count] %></span>
                </td>
                <td style="width: 40px">
                  <span style="font-size: 16px; font-weight: 700; color: rgb(111, 119, 125);">
                    <img width="18px" src="http://res.cloudinary.com/citizenlabco/image/upload/v1530712393/comment_srfoec.png" alt="Comment">
                  </span>
                  <span style="font-size: 14px; font-weight: 700;"><%= succesful_initiative[:comments_count] %></span>
                </td>
              </tr>
            <mj-text>&nbsp;</mj-text>
          </mj-table>
        <mj-raw><% end %></mj-raw>
      </mj-column>
    </mj-section>

    <!-- CTA button -->
    <%= render partial: "application/cta_button", locals: {
      href: @url_service.home_url(tenant: @tenant, locale: @locale),
      message: formatMessage('cta_go_to_the_platform')
    } %>

    <%= render partial: "application/footer" %>

  </mj-body>
</mjml>