import { randomString } from '../../../support/commands';

describe('Admin: update HomePage content', () => {
  before(() => {
    cy.setAdminLoginCookie();
    cy.visit('/admin/pages-menu/');
    cy.acceptCookies();
    cy.apiUpdateHomepageSettings({
      top_info_section_enabled: false,
      bottom_info_section_enabled: false,
      events_widget_enabled: false,
    });
  });

  it('updates top and bottom info section content and visibility', () => {
    cy.intercept('PATCH', '**/home_page').as('saveHomePage');
    cy.intercept('GET', '**/home_page').as('getHomePage');

    const topInfoContent = randomString();
    const bottomInfoContent = randomString();

    // go to page with homepage settings toggles
    cy.get('[data-testid="edit-button"]').first().click();

    // visit and update top into section edit page
    cy.get(
      '[data-cy="e2e-admin-edit-button-top_info_section_enabled"]'
    ).click();
    cy.get('.e2e-localeswitcher').each((button) => {
      cy.wrap(button).click();
      cy.get('#top_info_section_multiloc-en').clear().type(topInfoContent);
    });
    cy.get('[data-cy="e2e-top-info-section-submit"').click();

    // // go back home
    cy.get('[data-cy="breadcrumbs-Home"]').click();

    // // visit and update bottom into section edit page
    cy.get(
      '[data-cy="e2e-admin-edit-button-bottom_info_section_enabled"]'
    ).click();
    cy.get('.e2e-localeswitcher').each((button) => {
      cy.wrap(button).click();
      cy.get('#bottom_info_section_multiloc-en')
        .clear()
        .type(bottomInfoContent);
    });
    cy.get('[data-cy="e2e-bottom-info-section-submit"').click();

    // go to home page, check that the content is not there yet
    cy.visit('/');
    cy.get('[data-testid="e2e-landing-page-top-info-section"]').should(
      'not.exist'
    );
    cy.get('[data-testid="e2e-landing-page-bottom-info-section"]').should(
      'not.exist'
    );
    cy.get('[data-testid="e2e-events-widget-container"]').should('not.exist');

    // go back to edit the page
    cy.visit('/admin/pages-menu/');
    cy.get('[data-testid="edit-button"]').first().click();

    // toggle top info section and wait for requests to complete
    cy.get(
      '[data-cy="e2e-admin-section-toggle-top_info_section_enabled"]'
    ).click();
    cy.wait('@saveHomePage');

    // wait for the next toggle to become disabled, then enabled again once it finishes toggling
    cy.get('[data-cy="e2e-admin-section-toggle-bottom_info_section_enabled"]')
      .find('i')
      .should('have.class', 'disabled');
    cy.get('[data-cy="e2e-admin-section-toggle-bottom_info_section_enabled"]')
      .find('i')
      .should('have.class', 'enabled');

    // click bottom info section toggle and wait for requests to complete
    cy.get(
      '[data-cy="e2e-admin-section-toggle-bottom_info_section_enabled"]'
    ).click();
    cy.wait('@saveHomePage');

    // wait for the next toggle to become disabled, then enabled again once it finishes toggling
    cy.get('[data-cy="e2e-admin-section-toggle-events_widget_enabled"]')
      .find('i')
      .should('have.class', 'disabled');
    cy.get('[data-cy="e2e-admin-section-toggle-events_widget_enabled"]')
      .find('i')
      .should('have.class', 'enabled');

    // toggle events section and wait for requests to complete
    cy.get(
      '[data-cy="e2e-admin-section-toggle-events_widget_enabled"]'
    ).click();
    cy.wait('@saveHomePage');

    // go back to homepage and see that the content is there correctly
    cy.visit('/');
    cy.contains(topInfoContent);
    cy.contains(bottomInfoContent);
    cy.get('[data-testid="e2e-events-widget-container"]').should('exist');
  });

  after(() => {
    cy.apiUpdateHomepageSettings({
      top_info_section_enabled: false,
      bottom_info_section_enabled: false,
      events_widget_enabled: false,
    });
  });
});
